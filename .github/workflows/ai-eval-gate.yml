name: AI Agent Evaluation Gate

# ─────────────────────────────────────────────────────────────────────────────
# TWO-ENVIRONMENT FLOW
#
#  pull_request → evaluate job  (TEST environment, agent: azure-dev-assistant-ci)
#                 Runs AI evals. If they fail, the PR is blocked.
#                 PRODUCTION is never touched.
#
#  push to main  → deploy-prod job  (PROD environment, agent: azure-dev-assistant)
#                  Only reachable after a PR merges (meaning evals already passed).
#                  This is the ONLY path that updates the production agent.
# ─────────────────────────────────────────────────────────────────────────────

on:
  pull_request:
    branches: [main]
    paths:
      - "agent/**"
      - "evals/**"
  push:
    branches: [main]
    paths:
      - "agent/**"
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: write
  id-token: write

jobs:
  # ───────────────────────────────────────────────────────────────────────────
  # JOB 1: Evaluate — runs on every PR (and manual dispatch)
  # Uses the TEST project endpoint and a CI-specific agent name.
  # A failed eval here blocks the PR. Production is untouched.
  # ───────────────────────────────────────────────────────────────────────────
  evaluate:
    name: Evaluate Agent (Test Environment)
    if: github.event_name == 'pull_request' || github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: pip install -r requirements.txt

      - name: Azure login (service principal)
        uses: azure/login@v2
        with:
          creds: |
            {
              "clientId": "${{ secrets.AZURE_CLIENT_ID }}",
              "clientSecret": "${{ secrets.AZURE_CLIENT_SECRET }}",
              "tenantId": "${{ secrets.AZURE_TENANT_ID }}",
              "subscriptionId": "${{ secrets.AZURE_SUBSCRIPTION_ID }}"
            }

      - name: Run evaluation gate (test environment)
        id: eval
        env:
          # AZURE_AI_PROJECT_TEST = test Foundry resource endpoint.
          # For v1 (single resource), set this to the same value as AZURE_AI_PROJECT.
          # For v2 (separate resources), point at the dedicated test resource.
          AZURE_AI_PROJECT: ${{ secrets.AZURE_AI_PROJECT_TEST }}
          AZURE_JUDGE_DEPLOYMENT: gpt-4o
          # CI agent name — keeps the production agent (azure-dev-assistant) untouched
          # during a PR eval run.
          AZURE_AGENT_NAME_OVERRIDE: azure-dev-assistant-ci
        run: python -m evals.run_eval_gate

      - name: Post PR comment
        if: always() && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const outcome = '${{ steps.eval.outcome }}';
            const passed = outcome === 'success';
            const icon = passed ? '✅' : '❌';
            const status = passed ? 'PASSED — PR is clear to merge' : 'FAILED — merge is blocked';

            const fs = require('fs');
            let summary = '';
            try { summary = fs.readFileSync(process.env.GITHUB_STEP_SUMMARY, 'utf8'); } catch {}

            const body = [
              `## ${icon} AI Evaluation Gate: ${status}`,
              '',
              summary || '_No detailed metrics available._',
              '',
              `**Workflow run:** ${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`,
            ].join('\n');

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body,
            });

  # ───────────────────────────────────────────────────────────────────────────
  # JOB 2: Deploy to Production — runs only after a successful merge to main
  # Uses the PROD project endpoint and the real production agent name.
  # This job is unreachable without a merged PR, which requires passing evals.
  # ───────────────────────────────────────────────────────────────────────────
  deploy-prod:
    name: Deploy Agent to Production
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: pip install -r requirements.txt

      - name: Azure login (service principal)
        uses: azure/login@v2
        with:
          creds: |
            {
              "clientId": "${{ secrets.AZURE_CLIENT_ID }}",
              "clientSecret": "${{ secrets.AZURE_CLIENT_SECRET }}",
              "tenantId": "${{ secrets.AZURE_TENANT_ID }}",
              "subscriptionId": "${{ secrets.AZURE_SUBSCRIPTION_ID }}"
            }

      - name: Deploy approved agent to production
        env:
          # AZURE_AI_PROJECT = production Foundry resource endpoint
          AZURE_AI_PROJECT: ${{ secrets.AZURE_AI_PROJECT }}
        run: python agent/agent_client.py
